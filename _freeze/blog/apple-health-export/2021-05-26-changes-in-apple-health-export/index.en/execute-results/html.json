{
  "hash": "dfcae7ffc01430ba16fb2a18ee519afd",
  "result": {
    "markdown": "---\ntitle: Changes in Apple Health Export\ndate: '2021-05-25'\nslug: changes-in-apple-health-export\ndescription: Another post on the contents of the Apple Health Export. This post shows how some measures have changed as new version of Watch and iPhone have been released. The examples focus on resting heart rate and VO2 Max.\"\nimage: \"feature-resting-hr.png\"\nabstract: |\n  A post that goes into some detail on how to import the Apple Health Export\n  and correct the time stamps.\ncategories:\n  - Apple-Health-Export\n  - R\ntags:\n  - Apple-Health-Export\n  - R\nsubtitle: ''\npart: 3\noutput: \n  blogdown::html_page:\n    # figure parameters based on recommendation in Hadley's book \n    toc: true\n    highlight: tango\n    number_sections: false\n    fig_width: 7\n    out.width: \"100%\" \n    fig.align: \"center\"\n    fig.asp: 0.618  \neditor_options:\n  markdown: \n    wrap: 72\n---\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\n\\[Updated September 4, 2021\\]\n\nThis is a follow-up to an [earlier\npost](https://www.johngoldin.com/blog/2020-02-apple-health-export-1/)\nexploring the Apple Health Export. The earlier post describes how to\nexport the Health data from the iPhone and import it into R.\n\nThis post will look at issues of the stability of how some summary\nmeasures are defined and look for other changes in the export.\n\nAt the end of the post I have included some of the R code used to create\nthis post to illustrate some tips on using `ggplot2` offered by [Cédric\nScherer](https://z3tt.github.io/OutlierConf2021/)\n\n### Resting Heart Rate\n\nAccording to\n[Wikipedia](https://en.wikipedia.org/wiki/Heart_rate#Resting_heart_rate):\n\n> resting heart rate ... is defined as the heart rate when a person is\n> awake, in a neutrally temperate environment, and has not been subject\n> to any recent exertion or stimulation, such as stress or surprise.\n\nBut note the passive voice. In practice I have not found clarity about\nthe conceptual definition of resting heart rate. One must be aware of\nthe *operational definition*, that is, how is the measurement actually\nmade. Let's start with the national norms compiled by the CDC. They\nconduct an annual survey called NHANES (National Health and Nutrition\nExamination Survey). NHANES includes information on pulse rate as part\nof their measurement of blood pressure. The protocol for collecting data\nfor NHANES is specified in exhaustive detail in their [physician\nprocedures\nmanual](https://wwwn.cdc.gov/Nchs/Data/Nhanes/2015-2016/Manuals/2015_Physician_Examination_Procedures_Manual.pdf).\nFor individuals eight years or older, pulse is taken as part of the\nprocedure for measuring blood pressure. First there are elaborate\ninstructions on how to measure for the size of blood pressure cuff\nneeded and how to place the cuff. The next step is the measurement of\npulse:\n\n> The pulse is taken after the SP \\[subject person\\] has been seated and\n> resting quietly for at least 3 minutes. Position the arm with the\n> right palm upward. Palpate the radial pulse on the lateral flexor\n> surface of the wrist with the pads of the index and middle figure. The\n> pulse is counted for 30 seconds and the number of beats in a 30-second\n> period is entered in the heart rate field.\n\nSo the national norms for heart rate are based on putting on a blood\npressure cuff, sitting quietly for at least 3 minutes, and then a\nphysician takes your pulse. That procedure leads to articles such as\n[Relation of Higher Resting Heart Rate to Risk of Cardiovascular Versus\nNoncardiovascular Death](https://pubmed.ncbi.nlm.nih.gov/28132682/)\nwhich used NHANES data to examine the association of higher resting\nheart rate with mortality. In other words, the procedure is the\noperational definition of \"resting heart rate\" in studies based on\nNHANES.\n\nNew devices such as Fitbit or Apple Watch make the measurement procedure\nused by NHANES seem like the horse and buggy days. With wearable\ndevices, there may be hundreds of heart rate readings during the day.\nWhich one is interpreted as being the resting heart rate? The key issues\nis how one interprets \"resting.\"\n\n### How does the Apple Watch measure resting heart rate?\n\nHere's what the Apple [developer\ndocumentation](https://developer.apple.com/documentation/healthkit/hkquantitytypeidentifier/2867756-restingheartrate)\nsays about resting heart rate:\n\n> Resting heart rate is commonly correlated with overall cardiovascular\n> health. It is an estimation of the user's lowest heart rate during\n> periods of rest, and is intended to be used as a medically relevant\n> metric. A resting heart rate sample is different than a sedentary\n> heart rate sample (that is, a sample using the heartRate identifier\n> with a HKHeartRateMotionContext.sedentary motion context). For\n> example, if the user finishes a high-intensity workout, and then sits\n> down to rest, the next heart rate sample may be marked as a sedentary\n> sample, but it is still much higher than the user's actual resting\n> heart rate. To produce more accurate results, the system estimates the\n> resting heart rate by analyzing sedentary heart rate samples\n> throughout the day.\n\n> Because the resting heart rate estimates become more accurate as the\n> day progresses, the system may delete earlier samples and replace them\n> with better estimates. Apple Watch replaces only the samples written\n> by the watch for the current or previous day.\n\nThat text is fairly long and seems very concrete, but it is not so clear\nwhat it means in practice. I will dive deep into my own data to try to\nobserve what is actually happening with the measurement of resting heart\nrate.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](index.en_files/figure-html/base_resting_hr_figure-1.png){width=672}\n:::\n:::\n\n\nThis figure shows my daily resting heart rate back to 2017. I have added\na smoothed curve to show the trend during this time period. Note that\nresting heart rate seems to be higher in winter and lower in summer.\nThat's interesting and not something I noticed until I did this graph.\n\nYou can also see that my heart rate is noticeably higher starting around\nDecember of 2020. Should I interpret that as being medically\nsignificant? Has my health changed? Has my fitness level changed?\n\nWe'll see that the change is in how Apple constructs \"resting heart\nrate\" rather than in me.\n\nThe next figure adds vertical green lines to show when I upgraded the\nWatch OS software.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index.en_files/figure-html/resting_hr_figure_with_version-1.png){width=672}\n:::\n:::\n\n\nIt's clear that resting heart rate was suddenly higher after I upgraded\nto Version 7 of WatchOS. I did some searching, but the [release notes\nfor Version\n7](https://www.apple.com/newsroom/2020/06/watchos-7-adds-significant-personalization-health-and-fitness-features-to-apple-watch/)\ndon't mention this. I did come across a brief article by [Harry\nGuinness](https://www.howtogeek.com/711238/why-your-resting-heart-rate-just-got-higher-on-apple-watch/)\nin which he picked up on this change. He noted that Version 7 also\nintroduced Apple sleep tracking. What appears to be going on is that\nbefore Version 7, resting heart rate was close to the lowest heart rate\nwhile one is asleep (if, like me, you wear the watch at night). He also\npointed out that when you go to the Resting Heart Rate section of the\nHealth app, at the bottom of the screen there is an \"about Resting Heart\nRate\" note that partly explains what they are doing:\n\n> Your resting heart rate is the average heart beats per minute measured\n> when you've been inactive or relaxed for several minutes.... Resting\n> heart rate does not include your heart rate while you're asleep.\n\nThe key qualifier is \"not while you're asleep\" combined with the fact\nthat Apple didn't start tracking sleep until Version 7. Before Version 7\nthe calculation of resting heart rate couldn't take note of whether or\nnot you were asleep, only whether you were inactive.\n\nSo Apple isn't hiding what they are doing, but they didn't do anything\nto help users interpret changes in their resting heart rate. On the\nApple discussion board, there's a\n[thread](https://discussions.apple.com/thread/251819127) in which users\ntry to puzzle out what is happening to their resting heart rate.\n\nHere's yet another graph of my resting heart rate, but in this one I\nshow a separate smoothed trend line for the periods before and after I\nupgraded to Version 7.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index.en_files/figure-html/resting_hr_two_parts-1.png){width=672}\n:::\n:::\n\n\nJust to beat this issue to death, I did a bit more digging into the\ndetails of the Apple Health Export. For each data row of the export\nthere is a start date and an end date (where date in R terms is a\n`datetime` value with both date and time). For resting heart rate, the\nstart date is usually just after midnight at the start of the new day.\nThe end date varies quite a bit and changes with Version 7. The next\ngraph shows the time of day for those end dates. You can see that after\nVersion 7, the time of day for the end date generally occurs before my\nnormal bedtime, i.e., while I'm still awake.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index.en_files/figure-html/resting_hr_tod-1.png){width=672}\n:::\n:::\n\n\nNo doubt Apple will improve how it identifies when one is asleep. That\nmay directly affect the measurement of resting heart rate. In general\nterms, for the Apple Watch and for other wearables such as Fitbit, to\ninterpret resting heart rate you need to know whether \"resting\" includes\nsleep time.\n\n### VO2 Max\n\nVO2 Max is the rate of oxygen consumption during heavy exercise. Direct\nmeasures of VO2 Max involve exercising while wearing a face mask that\nmeasures oxygen and carbon dioxide concentration of the inhaled and\nexhaled air. Obviously that's not something your Apple Watch can do.\nInstead, Apple estimates VO2 Max. The [Wikipedia article on VO2\nMax](https://en.wikipedia.org/wiki/VO2_max) describes a number of\ndifferent methods for estimating VO2 Max. What does Apple do? Who knows.\nThat's the kind of thing that Apple keeps close to the vest.\n\nHere is the [description of VO2\nMax](https://developer.apple.com/documentation/healthkit/hkquantitytypeidentifier/2867757-vo2max)\nprovided by the Apple Developer Documentation:\n\n> Understand Estimated Test Results\n>\n> Apple Watch Series 3 and later estimates the user's VO2max by\n> measuring the user's heart rate response to exercise. The system can\n> generate VO2max samples after an outdoor walk, outdoor run, or hiking\n> workout. During the outdoor activity, the user must cover relatively\n> flat ground (a grade of less than 5% incline or decline) with adequate\n> GPS, heart rate signal quality, and sufficient exertion. The user must\n> maintain a heart rate approximately greater than or equal to 130% of\n> their resting heart rate. The system can estimate VO2max ranges from\n> 14-60 ml/kg/min\n>\n> The user must wear their Apple Watch for at least one day before the\n> system can generate the first vo2Max sample. Additionally, the system\n> doesn't generate a vo2Max sample on the user's first workout. However,\n> it can make estimates based on data collected outside a workout\n> session.\n>\n> Apple Watch estimates VO2max based on sub-maximal predictions rather\n> than peakVO2. Users don't need to achieve peak heart rate to receive\n> an estimate; however, the system dose need to estimate their peak\n> heart rate. Users who take medications that may reduce their peak\n> heart rate can toggle a medication switch in the Health app to enable\n> more accurate VO2max estimates.\n\nAs with resting heart rate, let's look at my values for VO2 Max to see\nwhat it reveals.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Expected 3 pieces. Additional pieces discarded in 1 rows [8].\n```\n:::\n\n::: {.cell-output-display}\n![](index.en_files/figure-html/vo2max-1.png){width=672}\n:::\n:::\n\n\nWhat can I make of these changes over time? It's evident that the\nestimated value of VO2 Max is dominated by the details of how estimation\nis done during each version of Watch OS. There are dramatic changes in\nthis chart that have little (or nothing) to do with my fitness.\n\nWhat about the trend within each version of Watch OS? For example,\nduring Version 7 my VO2 Max has been on a steady upward march. No, I\ncan't relate that to the personal experience of my fitness. I do a\nchallenging three-mile walk in the woods almost every day with an\noccasional longer walk thrown in from time to time. It's hard to imagine\nwhat estimation procedure would produce these trends. In Version 7 of\nWatch OS perhaps the procedure starts with an estimate based only on\nheight, weight, age, and gender and then modifies it based on\nobservation of workouts. Looking at the period during Version 6, there\nwas a big drop on March 17, 2020 and then a big increase on April 9.\nWhen I look at the details of the workouts during that time period I\ndon't see anything that would relate to a change in estimated VO2 Max.\nMy conclusion is that I should not attribute short-run changes in the\nestimated VO2 Max to actual changes in my cardio fitness.\n\nThe [press release for Watch OS\n7](https://www.apple.com/newsroom/2020/09/apple-watch-series-6-delivers-breakthrough-wellness-and-fitness-capabilities/)\nintroduced \"low range VO2 Max\"\n\n> Apple Watch already estimates average and higher levels of VO2 max\n> during vigorous outdoor walks, runs, or hikes, which many runners and\n> other athletes monitor to improve performance. Now, with watchOS 7,\n> Apple Watch uses multiple sensors, including the optical heart sensor,\n> GPS, and the accelerometer, to estimate lower levels, too.\n\nI don't know whether the low range VO2 Max had any effect on me. It's\nlikely that my normal daily walk was sufficient to estimate VO2 Max so\nthey low range estimation procedure was never needed.\n\nIncluding an estimate of VO2 Max is an interesting concept, but so far\nit seem that both the short run variations the long-term trend are\naffected by changes in the estimation procedure. VO2 Max won't be useful\nuntil Apple settles on a stable methodology. I look forward to seeing\nthat someday.\n\nAn overall theme of this post is that one should expect there will be\nadditional future changes in the Apple Health Kit as Apple works to\nimprove their health and fitness information. Of course we as customers\nwant it to improve. That means that when interpreting long term trends\nin the data one has to allow for the possibility that the definition of\nmeasures have changed.\n\n### What Happened to My Million Rows of Data?\n\nWhen I did my [first\npost](https://johngoldin.com/2020/02/apple-health-export-part-i/) on the\nApple Health Export, I had a total of 4,012,907 rows of data. My most\nrecent export has only 3,026,367 so about a million rows smaller even\nthough I have added a whole additional year of data. What gives?\n\nFortunately I had an archive of the dataset that I used from a year\nearlier. I did a `full_join` of the two datasets by start time, end\ntime, and type. It was very easy to spot the source of the change. At\nsome point during the last year Apple changed how the export handles\nworkouts. Data outside of workouts is unchanged. For workouts older than\n90 days, the export now summarizes the items that are frequently\nmeasured: Active Energy Burned, Basal Energy Burned, Heart Rate, and\nDistance Walking or Running. The two energy items and distance are each\nsummed over a five minute period. Heart rate is the average over a ten\nminute period.\\\nNormally heart rate is reported as a whole number, but in the summarized\nworkout data it is now displayed to one decimal point.\n\nOn a typical 65-minute outdoor walk done within the last three months\nthe export has 1,515 Active Energy and Basal Energy measures, 658 Heart\nRate readings, and 1,493 Distance Walking Running measures. For the same\nwalk done more than three months ago, there are only 15 Active and Basal\nEnergy measures, 7 Heart Rate, and 13 Distance. There are about\none-tenth as many measures in the older workouts and each value is a\nsummary for a period of time. Workouts generate a very large number of\nmeasurements so summarizing those measurements can make a big difference\nin the size of the exported dataset.\n\nDoes this matter? Summarizing some of the workout detail seems\nreasonable. Although one might imagine a hypothetical case where the\ndetail in the older workouts would be needed, it doesn't seem like a\npractical problem. I write crazy blog posts like this so in my case I\nmay try to archive a copy of the data every 90 days, just in case.\n\nI wondered whether the details were removed from the Health Kit data on\nmy phone or only in the Health Export. When I use the Fitness app to\nlook at old workouts I can still see all of the detail of the heart rate\nmeasurements. It's clear that a summary of workout data is created for\nthe Health Export, but the actual data remains on the iPhone. So all of\nthe detail is still there, it's just not included in the export. Using\nthe premium version of the [Heart Analyzer\napp](https://apps.apple.com/us/app/heart-analyzer/id1006420410) (which\nis only \\$1.99), one can clearly see that the original heart rate data\nis available even for older months that are summarized in the Health\nExport.\n\n### How Do We Know What the Health Measures Actually Measure?\n\nApple wants the Watch to be taken seriously as a medical device. To take\nthe Health items seriously, one needs to have confidence in them.\nGreater transparency would help to support trust. Apple may not be\nwilling to describe the operational definition of the summary\nmeasurements they provide. That makes it harder to determine what is\nactually being measured. Here we have looked at resting heart rate and\nVO2max and alluded to sleep.\n\nThere's an interesting\n[article](https://www.theverge.com/2020/10/7/21504023/apple-watch-ekg-blood-oxygen-fda-clearance)\nin The Verge by Nicole Wetsman that discusses why Apple got FDA approval\nfor its EKG feature but not for its measurement of blood oxygen level.\n\n> Blood oxygen monitors, or pulse oximeters, are considered Class II\n> medical devices by the FDA. Generally, any company that wants to sell\n> one in the United States has to submit documentation to the agency\n> confirming that its product works just as well as other versions of\n> the same product already on the market. There's a workaround, though:\n> if the company says that the product is just for fun, or for general\n> \"wellness,\" they don't have to go through that process.\n\nIt's convenient for Apple to keep users at arms length and hide the\ntechnical details. That means we get a verbal description of what a\nmeasure is supposed to do, but we may not be able to understand the\noperational definition of what the measure actually does. The health\nmeasures in many cases are still in an early stage of development. They\nwill be improved over time. Improvement means change, in a good way. But\nit also means that one must be very careful about the interpretation of\nlong-term trends.\n\n### An Update Concerning VO2 Max\n\nIn September 2021, after I first published this post, a web search led\nme to a [technical\narticle](https://www.apple.com/healthcare/docs/site/Using_Apple_Watch_to_Estimate_Cardio_Fitness_with_VO2_max.pdf)\nthat provides a great deal of detail about how Apple created their\nestimate of VO2 Max. The article is posted in the\n[healthcare](https://www.apple.com/healthcare/) section of their web\nsite, although I only found it as a result of a web search. I don't see\nwhere it is listed at the healthcare site. In any case, I give credit\nfor creating some substantial background information rather than simply\nasking us to accept their measures on faith.\n\n> A VO2 max value may be generated after walking, running, or hiking\n> outdoors on relatively flat ground (that is, a grade of less than 5\n> percent incline or decline) with adequate GPS, heart rate signal\n> quality, and exertion (an approximate increase of 30 percent of the\n> range from resting heart rate to max).\n\nThey study describes the study used to create the estimates of VO2 Max\nintroduced with OS7. I was happy to see that 38% of the participants is\nthe study were over 65. They report that the correlation between their\nestimate of VO2 Max with a direct measure via cardiopulmonary exercise\ntesting is 0.89 for men and 0.86 for women.\n\n## Appendix: Some of the R Code Used to Make This Post\n\nIn my [earlier\npost](https://www.johngoldin.com/blog/2020-02-apple-health-export-1/) I\nincluded a lot of R code for setting up the Health Export data. Here\nI'll describe some of the additional code used for this post. Some of\nthis code will focus on how to work with the Health Export. But I also\nused this post to try some suggested code for `ggplot2` so I'll feature\nthat code here as well.\n\n### R Code for the `ggplot2` Figures\n\nThe figures relied on the `ggtext` and `ggforce` packages to add some\nextras to figures based on [tips from Cédric\nScherer](https://z3tt.github.io/OutlierConf2021/).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(scico)       ## scico color palettes(http://www.fabiocrameri.ch/colourmaps.php) in R \nlibrary(ggtext)      ## add improved text rendering to ggplot2\nlibrary(ggforce)     ## add missing functionality to ggplot2\nlibrary(ggdist)      ## add uncertainity visualizations to ggplot2\nlibrary(patchwork)   ## combine outputs from ggplot2\n# library(Cairo)\n#   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #\n#\n# Here is the code to create the Resting Heart Rate plots\n#\n#   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #\n#\n# copied directly from: https://github.com/Z3tt/OutlierConf2021/blob/main/R/OutlierConf2021_ggplotWizardry_HandsOn.Rmd\n# You should have package Cairo installed if you use ggsave:\n# i.e., add device = cairo_pdf in ggsave call.\n## change global theme settings (for all following plots)\n#  IMPORTANT!!! open sans font must be installed (see next line)\n# open sans downloaded from https://fonts.google.com/specimen/Open+Sans?preview.text_type=custom\n# for tips on extra fonts on windows, see https://www.williamrchase.com/post/custom-fonts-and-plot-quality-with-ggplot-on-windows/\n# based on William Chase, I may also try Alegreya Sans from https://www.huertatipografica.com/en/fonts/alegreya-sans-ht\ntheme_set(theme_minimal(base_size = 12, base_family = \"Open Sans\")) #originally 12\n## modify plot elements globally (for all following plots)\ntheme_update(\n  axis.ticks = element_line(color = \"grey92\"),\n  axis.ticks.length = unit(.5, \"lines\"),\n  panel.grid.minor = element_blank(),\n  legend.title = element_text(size = 12),\n  legend.text = element_text(color = \"grey30\"), \n  plot.title = element_text(size = 14, face = \"bold\"),  # originally 18\n  plot.subtitle = element_text(size = 10, color = \"grey30\"), # originally 12\n  plot.caption = element_text(size = 9, margin = margin(t = 15))\n)\n\n# resting_hr <- health_df %>% filter(sourceName == \"Watch\") %>% \n#   filter(type == \"RestingHeartRate\")\n\ndup_resting <- resting_hr %>% count(local_date) %>% filter(n > 1) %>% arrange(desc(local_date))\n\nhr_versions <- unique(resting_hr %>% filter(str_detect(sourceName, \"Watch\"), !is.na(sourceVersion)) %>% \n                     select(sourceVersion)) %>% \n                     separate(sourceVersion, into = c(\"major\", \"minor\", \"subminor\"), remove = FALSE) %>% \n  mutate(subminor = ifelse(is.na(subminor), \"0\", subminor)) %>% \n  arrange(sourceVersion)\n\nhr_boundaries <- resting_hr %>% \n  left_join(hr_versions, by = \"sourceVersion\") %>% \n  arrange(sourceVersion, local_start, creationDate) %>% \n  group_by(sourceVersion, major, minor, subminor) %>% \n  summarise(first_date = first(local_start), last_date = last(local_start))\n\nhr_boundaries <- hr_boundaries %>% \n  ungroup() %>% \n  arrange(first_date) %>% \n  mutate(test = lag(major),\n         test2 = lead(major),\n    level = case_when(\n    major != lag(major) ~ 3,\n    minor != lag(minor) ~ 2,\n    subminor != lag(subminor) ~ 1,\n    TRUE ~ NA_real_\n  ))\nmin_date <- min(resting_hr$local_date[resting_hr$type == \"RestingHeartRate\"])\nmax_date <- max(resting_hr$local_date[resting_hr$type == \"RestingHeartRate\"])\nmin_resting_heart_rate <- min(resting_hr$value[resting_hr$type == \"RestingHeartRate\"])\nhalf_year_sequence <- seq(floor_date(min_date, \"year\"), ceiling_date(max_date, \"year\"), by = \"quarter\")\nhalf_year_sequence <- half_year_sequence[month(half_year_sequence) %in% c(1, 7)]\n\np_noversion1 <- ggplot(data = resting_hr, aes(x = local_date, y = value)) +\n  geom_point(size = 0.5, alpha = .6) +\n  scale_x_date(limits = c(min_date + 0, max_date - 0), \n               date_labels = \"%b %Y\",\n               breaks = half_year_sequence)  + \n  scale_y_continuous(breaks = seq(45, 65, by = 5), \n                     limits = c(min_resting_heart_rate, NA)) +\n  labs(\n    title = 'My Resting Heart Rate by Day', \n    subtitle = 'Data from Apple Watch via Health Export',\n    x = NULL,\n    y = 'Resting Heart Rate'\n  )\n# ggsave(\"temp.png\", p_noversion1, width = 9, height = 8, device = cairo_pdf, dpi = \"retina\")\n\n#  as.hexmode(col2rgb(\"seagreen3\"))   # #43cd80  (to use with HTML)\n# I could have added some R code to create the HTML, but this is easier\n\np_noversion2 <- p_noversion1 +\n  geom_smooth(fill = \"lightgrey\")\np_version0 <- p_noversion1 +\n  labs(subtitle = '<i style=\"color:#28A87D;\">Vertical lines show major and minor versions of Watch OS</i>') +\n  theme(\n    plot.subtitle = ggtext::element_markdown())\np_version1 <- p_version0 +\n  geom_vline(data = hr_boundaries %>% filter(level == 3), \n             aes(xintercept = as_date(first_date)), size = 1, colour = \"seagreen3\", alpha = 0.6) +\n  geom_richtext(data = hr_boundaries %>% filter(level == 3),\n            aes(label = paste0(\"**v\", sourceVersion, \"**\"), x = as_date(first_date), y = Inf), \n            colour = \"seagreen3\", alpha = 0.6, hjust = 0, vjust = 1, nudge_x = 5, size = 3.5) +\n  geom_vline(data = hr_boundaries %>% filter(level == 2), \n             aes(xintercept = as_date(first_date)), size = 0.3, colour = \"seagreen2\", alpha = 0.6)\np_version2 = p_version1 + geom_smooth(fill = \"lightgrey\")\nbig_change <- hr_boundaries$first_date[hr_boundaries$sourceVersion == \"7.0\"] %>% as_date()\np_version3 <- p_version1 +\n  geom_smooth(data = resting_hr %>% filter(local_date < big_change)) +\n  geom_smooth(data = resting_hr %>% filter(local_date >= big_change)) \n\n\np_tod1 <- ggplot(data = resting_hr, aes(x = local_date, y = \n                                  as.integer(difftime(local_end, floor_date(local_end, \"day\"), unit = \"secs\")) %>% hms::hms())) +\n  geom_point(size = 0.5, alpha = 0.6) + \n  geom_vline(data = hr_boundaries %>% filter(level == 3), \n             aes(xintercept = as_date(first_date)), size = 1, colour = \"seagreen3\", alpha = 0.6) +\n  geom_richtext(data = hr_boundaries %>% filter(level == 3),\n            aes(label = paste0(\"**v\", sourceVersion, \"**\"), x = as_date(first_date), y = Inf), \n            colour = \"seagreen3\", alpha = 0.6, hjust = 0, vjust = 1, nudge_x = 5, size = 3.5) +\n  geom_vline(data = hr_boundaries %>% filter(level == 2), \n             aes(xintercept = as_date(first_date)), size = 0.3, colour = \"seagreen2\", alpha = 0.6) +\n  geom_vline(data = hr_boundaries %>% filter(level == 1), \n             aes(xintercept = as_date(first_date)), size = 0.3, colour = \"seagreen1\", alpha = 0.6, linetype = \"dotted\") +\n  scale_x_date(limits = c(min_date + 0, max_date - 0), \n               date_labels = \"%b %Y\",\n               breaks = half_year_sequence)  + \n  scale_y_time(labels = function(l) strftime(l, '%H:%M')) +  # thanks to https://stackoverflow.com/a/50173616/5828243\n  labs(\n    title = 'My Resting Heart Rate endDate Shown as Time of Day' , \n    subtitle = '<i style=\"color:#28A87D;\">Vertical lines show major and minor versions of Watch OS</i>',\n    x = NULL,\n    y = 'Resting Heart Rate endDate (hours:minutes)'\n  ) +\n  theme(\n    plot.subtitle = ggtext::element_markdown(),\n    plot.title = ggtext::element_markdown())\n# one can use the lines below to examine outliers\n# resting_hr %>%\n#   filter(sourceVersion > \"7.\", \n#          as.integer(difftime(local_end, floor_date(local_end, \"day\"), unit = \"secs\")) > hms::hms(0,0,21)) %>%\n#   select(value, local_start, local_end, creationDate, sourceVersion) %>%\n#   View()\n# p_tod1 + geom_point(data = resting_hr %>% filter(sourceVersion > \"7.\", as.integer(difftime(local_end, floor_date(local_end, \"day\"), unit = \"secs\")) > hms::hms(0,0,23)), colour = \"red\", size = 0.6, alpha = 0.6)\n```\n:::\n\n\n### Removing Duplicate Rows in the Export\n\nWhile working on this post I discovered that there were a fair number of\nduplicate rows in the Apple Health Export. Most of these are related to\nnon-Apple sources such as Lose It! or my Omron blood pressure cuff. But\nthere were some duplicates for other items as well. So I added a step to\nmy import to delete duplicates. One needs to exclude the `device` column\nbefore looking for duplicates.\n\nGenerally there is one row of resting heart rate data for each date. But\nsometimes a second rows is created, possibly when the iPhone is\nrestarted as part of an update or if there is a time change for daylight\nsavings.\n\nHere are the revised lines that eliminate the duplicate rows:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n      health_df <- XML:::xmlAttrsToDataFrame(health_xml[\"//Record\"], stringsAsFactors = FALSE) %>%\n        as_tibble() %>% mutate(value = as.numeric(value)) %>%\n        select(-device)  # the device column seems to cause some duplicate rows\n      check_count <- nrow(health_df)\n      health_df <- health_df %>% unique()   # unique adds at least two minutes. \n      # Had found 42,364 rows, mostly Lose It!, SleepMatic, and Omron, but some came from Watch and iPhone\n      dup_count <- check_count - nrow(health_df)\n```\n:::\n",
    "supporting": [
      "index.en_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}