{
  "hash": "b15f5d0417775554b31c9f73d7b1b251",
  "result": {
    "markdown": "---\ntitle: \"Ukraine MOD Statistics on Russian Losses\"\neditor: visual\nauthor: John Goldin\ndate: '2023-05-12'\n\nimage: \"UA-MOD-casualty-image.jpeg\"\nimage-alt: \"An example of a Russian casualty estimate as it appears on the Ukranian Ministry of Defense site\"\nimage-height: \"100px\"\nslug: ukraine-mod-stats\ncategories:\n  - Ukraine\ntags:\n  - Ukraine\ndescription: |\n  Scraped stats from Ukraine Ministry of Defense on Russian losses.\nlayout: single\nformat:\n  html:\n    code-fold: true\n    code-summary: \"Show the code\"\n    toc: true\n    fig-cap-location: top\nexecute: \n  echo: false\n---\n\n\nEach day the [Ministry of Defence of Ukraine](https://www.mil.gov.ua/en/news) publishes a summary of Russian combat losses since the beginning of the Russian invasion. Daily reports presented in a fairly constant format go back to April of 2022.\n\nThis blog post will describing downloading that info from the web and provide a simple plot to track the losses. I'm sure many others have done something similar.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\nThe Ministry of Defence of Ukraine has been reporting a summary of Russian losses each day, including a graphic version like this:\n\n![Russian losses reported by Ukraine Ministry of Defence](UA-MOD-casualty-image.jpg){width=\"376\"}\n\nThis is the Ukraine side of the story. It always refers to \"liquidated personnel,\" but there's some ambiguity about what that means.\n\n> The Ukrainians use the word \"liquidated\" to refer to the Russian losses. However, that word choice leaves the actual figure of killed and wounded up to interpretation. With \"liquidated\" Kyiv could mean \"killed\" or \"killed and wounded.\" -- Stavros Atlamazoglou at the website [19fortyfive.com](https://www.19fortyfive.com/2023/03/220000-dead-or-wounded-putins-ukraine-war-destroyed-the-russian-military/)\n\nPresumably the personnel losses are an estimate. There are lots of factors that could affect\nhow close these counts come to reality. Western intelligence sources sometimes report their\nown estimates of Russian losses. Those do not necessarily match these counts.\n\n\n::: {.cell file='~/Documents/R_local_repos/ukrainestats/R/ukraine_functions.R'}\n\n```{.r .cell-code .code-overflow-scroll  code-fold=\"true\" code-summary=\"Code which scrapes data from Ministry of Defense\" code-line-numbers=\"true\"}\n# using: https://www.scrapingdog.com/blog/web-scraping-r/\n# link <- \"https://www.mil.gov.ua/en/news/2023/03/08/the-total-combat-losses-of-the-enemy-from-24-02-2022-to-08-03-2023/\"\n# page = read_html(link, as_html = FALSE)\n# lines <- read_html(link)\n\nlibrary(tidyverse)\nlibrary(glue)\nlibrary(xml2)\n\n#' Extract the casualty count from a line in the report based on a regex search\n#'\n#'\n#'\n#' @param text The text of the web page that contains the casualty report.\n#' @param phrase The regex that will find the casualty number.\n#'\n#' @return The casualty number.\n#' @export\n#'\n#' @examples\n#' x <- str_extract(text, \"(?<=personnel [‒-] about )\\\\d*\")\nextract_number  <-  function(text, phrase = \"(?<=personnel [‒-] about )\\\\d*\") {\n  x <- str_extract(text, phrase)\n  if (is.na(x)) {\n    if (!str_detect(text, phrase)) stop(paste0(phrase, \" not found\"))\n    warning(paste0(\"number not found:\", text()))\n    return(NA_real_)\n  }\n  as.numeric(x)\n}\n\n# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #\n#\n# Notes on scraping and parsing the data on Russian losses from the\n# Ukraine Ministry of Defense web site:\n#\n# April 12, 2022 is earliest Russian casualty count\n#\n# Some dates that are missing data: \"2022-06-16\", \"2022-06-18\" (others in June)\n#\n# at this point doing two digit date for start of war and end\n# https://www.mil.gov.ua/en/news/2023/02/23/the-total-combat-losses-of-the-enemy-from-24-02-22-to-23-02-23/\n#\n#   back then two digit years\n# https://www.mil.gov.ua/en/news/2022/12/16/the-total-combat-losses-of-the-enemy-from-24-02-to-16-12/\n#\n#   https://www.mil.gov.ua/en/news/2022/12/31/the-total-combat-losses-of-the-enemy-from-24-02-to-31-12/\n#\n#   3/3/2023 seems to be start of using 4-digit year\n#\n# wrong:\n#   https://www.mil.gov.ua/en/news/2022/09/23/the-total-combat-losses-of-the-enemy-from-24-02-to-23-09/\n#\n#   On January 1, started doing two digit dates\n# https://www.mil.gov.ua/en/news/2023/01/03/the-total-combat-losses-of-the-enemy-from-24-02-22-to-03-01-23/\n#\n#   works\n# https://www.mil.gov.ua/en/news/2023/02/20/the-total-combat-losses-of-the-enemy-from-24-02-22-to-20-02-23/\n#\n#   does not work:\n#   https://www.mil.gov.ua/en/news/23/02/23/the-total-combat-losses-of-the-enemy-from-24-02-22-to-23-02-23/\n#\n#   does note work:\n#   https://www.mil.gov.ua/en/news/23/02/20/the-total-combat-losses-of-the-enemy-from-24-02-22-to-20-02-23/\n#\n#   works:\n#   https://www.mil.gov.ua/en/news/2022/05/09/the-total-combat-losses-of-the-enemy-from-24-02-to-09-05/\n#\n#   works:\n#   https://www.mil.gov.ua/en/news/2022/06/25/the-total-combat-losses-of-the-enemy-from-24-02-to-25-06/\n#\n#   works:\n#   https://www.mil.gov.ua/en/news/2022/04/16/the-total-combat-losses-of-the-enemy-from-24-02-to-16-04/\n#\n#   first phrase changed between 2022-04-16 and 2022-04-17\n# \"personnel ‒ about\" to\n#\n#\n# wrong:\n#   https://www.mil.gov.ua/en/news/2022/07/12/the-total-combat-losses-of-the-enemy-from-24-02-to-12-07/\n#\n#   wrong:\n#   https://www.mil.gov.ua/en/news/2022/06/20/the-total-combat-losses-of-the-enemy-from-24-02-to-20-06/\n#\n#   More than one line found 2022-06-06 and that goes until 2022-07-26 when hits error\n# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #\n\n\n#' Create a URL that goes to a standard Russian casualty report\n#'\n#' @param adate The Date for the report.\n#'\n#' @return String with the URL for the casualty report.\n#' @export\n#'\n#' @examples\ncreate_ukr_mod_link <- function(adate) {\n  if (!is.Date(adate)) adate <- as_date(adate)\n  if (is.na(adate)) {\n    warning(paste0(adate, \"is not a valid date.[increate_ukr_mod_link]\"))\n    return(\"\")\n  }\n  # must have this form:   (4 digit years)\n  # https://www.mil.gov.ua/en/news/2023/03/08/the-total-combat-losses-of-the-enemy-from-24-02-2022-to-08-03-2023/\n  if (adate == as_date(\"2023-03-30\")) link <-  \"https://www.mil.gov.ua/en/news/2023/03/30/blizko-173-tis-osib-znishheno-ponad-6970-bojovih-bronovanih-mashin-voroga-–-genshtab-zsu/\"\n  else if (adate >= as_date(\"2023-03-03\")) link <- glue(\"https://www.mil.gov.ua/en/news/\", format(adate, \"%Y/%m/%d\"), \"/the-total-combat-losses-of-the-enemy-from-24-02-2022-to-\", format(adate, \"%d-%m-%Y\"), \"/\")\n  else if (adate >= as_date(\"2023-01-01\")) link <- glue(\"https://www.mil.gov.ua/en/news/\", format(adate, \"%Y/%m/%d\"), \"/the-total-combat-losses-of-the-enemy-from-24-02-22-to-\", format(adate, \"%d-%m-%y\"), \"/\")\n  else link <- glue(\"https://www.mil.gov.ua/en/news/\", format(adate, \"%Y/%m/%d\"), \"/the-total-combat-losses-of-the-enemy-from-24-02-to-\", format(adate, \"%d-%m\"), \"/\")\n  link\n}\n\n#' Extract the lines from a Ukraine Ministry of Defense page that contain the Russian casualty counts\n#'\n#' @param adate Date of casualty report on Ukraine Ministry of Defense web site\n#' @param fetch_image_url Fetch the URL that displays the report as an image.\n#'\n#' @return List of text lines that contain the casualty reports, each category on different line.\n#' @export\n#'\n#' @examples\n#' fetch_mod_text(\"2023-03-29\")\n\nfetch_ukr_mod_text <- function(adate, fetch_image_url = FALSE) {\n  if (!is.Date(adate)) adate <- as_date(adate)\n  if (adate < ymd(\"2022-04-12\")) return(NA_character_)\n  if (adate > today()) return(NA_character_)\n\n  # what image line looks like:\n  # himg <- \"<a href=\\\"/assets/images/resources/69849/0b6b4d3834eddf4a9f1c0a30b788ca484d850890.jpg\\\" class=\\\"thumbnail\\\" data-image=\\\"/assets/images/resources/69849/0b6b4d3834eddf4a9f1c0a30b788ca484d850890.jpg\\\">\"\n  # from chatGPT:\n  # my_string <- \"This is a string with start some text end in the middle.\"\n  #\n  # # This regex pattern will extract the text between \"start\" and \"end\"\n  # extracted_text <- str_extract(my_string, \"(?<=start ).*(?= end)\")\n  # str_extract(himg, \"(?<=href=\\\").*(?=\\\" class)\")\n  # keep in mind: stringi::stri_reverse(\"abcde\")\n  # look for:  \"<base href=\\\"https://www.mil.gov.ua/en/\\\" />\"\n\n  link <- create_ukr_mod_link(adate)\n  x <- read_lines(link)\n\n  if (length(x) == 0) stop(paste0(\"For \", adate, \" Link not found. \", link))\n\n  if (fetch_image_url) {\n    # return an image URL, not casualty data\n    image_lines <-  x[str_detect(x, \"meta property=\\\"og:image\")]\n    if (length(image_lines) == 0) return(\"https://www.mil.gov.ua/assets/images/resources/69817/1ade4ec8f38bbaac946cff911451f14c3f551248.jpg\")\n    return(str_extract(image_lines[1], \"(?<=content=\\\").*(?=\\\" />)\"))\n  }\n  # image_lines <-  x[str_detect(x, \"meta property=\\\"og:image\")]\n  # str_extract(image_lines[1], \"(?<=content=\\\").*(?=\\\" />)\")\n  #\n  # the image of the report is in: x[str_detect(x, \"<a href=\\\"/assets/images/resources/\")]\n  #the_line <- x[x |> str_detect(\"personnel ‒ about\")]\n  # the_line <- x[x |> str_detect(\"The total combat losses of the enemy from\")]\n  if (adate <= ymd(\"2022-04-16\")) the_line <- x[str_detect(x, \"personnel ‒ about\")]\n  if (adate > ymd(\"2022-04-16\")) the_line <- x[str_detect(x, \"persons were liquidated\")]\n  if (length(the_line) == 0) {\n    warning(paste0(\"Info line not found for \", adate))\n    return(NA_character_)\n  }\n  # 2023-04-23 not read because text of report appears twice on the page\n  if (length(the_line) > 1) {\n    warning(paste0(\"More than one line found \", adate, \"\\n\", link))\n    return(NA_character_)\n  }\n  if (adate <= as_date(\"2022-04-16\")) first_line <- which(str_detect(x, \"personnel ‒ about\"))\n  if (adate > as_date(\"2022-04-16\"))  first_line <- which(str_detect(x, \"persons were liquidated\"))\n  last_line <- which(str_detect(x, \"special equipment\"))\n  if (is.na(last_line) || (length(last_line) == 0)) last_line <- which(str_detect(x, \"vehicles\"))\n  if (is.na(last_line) || (length(last_line) == 0)) last_line <- which(str_detect(x, \"UAV\"))\n  if (is.na(last_line) || (length(last_line) == 0)) last_line <- first_line + 10\n  # the_line\n  str_flatten(c(as.character(adate), x[first_line:last_line]))\n}\n\n#' Parse the Russian casualty info from Ukraine MOD summary pages.\n#'\n#' The text from each web page is in the report column. The extract_number\n#' function is used to find the casualties for each item, based on a regular expression\n#' to search for that type of item.\n#'\n#' @param mod_df A df which has a report column that contains the text from casualty web pages.\n#'\n#' @return The same df is returned, but with numeric columns added for each type of casualty.\n#' @export\n#'\n#' @examples\nparse_ukr_mod_text <- function(mod_df) {\n  mod_df$personnel = map_dbl(str_replace_all(mod_df$report, intToUtf8(160), \"\"), extract_number, phrase = \"(?<=personnel ?[‒-–-] ? ?about )\\\\d*\" )\n  mod_df$tanks = map_dbl(mod_df$report, extract_number, phrase = \"(?<=tanks [‒-–-] )\\\\d*\" )\n  mod_df$apv = map_dbl(mod_df$report, extract_number, phrase = \"(?<=APV [‒-–-] )\\\\d*\" )\n  mod_df$artillery = map_dbl(mod_df$report, extract_number, phrase = \"(?<=artillery systems [‒-–-] )\\\\d*\" )\n  mod_df$mlrs = map_dbl(mod_df$report, extract_number, phrase = \"(?<=MLRS [‒-–-] )\\\\d*\" )\n  mod_df$aa = map_dbl(mod_df$report, extract_number, phrase = \"(?<=Anti-aircraft warfare systems [‒-–-] )\\\\d*\" )\n  mod_df$aircraft = map_dbl(mod_df$report, extract_number, phrase = \"(?<=aircraft [‒-–-] )\\\\d*\" )\n  mod_df$helicopters = map_dbl(mod_df$report, extract_number, phrase = \"(?<=helicopters [‒-–-] )\\\\d*\" )\n  mod_df$uav = map_dbl(mod_df$report, extract_number, phrase = \"(?<=UAV operational-tactical level [‒-–-] )\\\\d*\" )\n  mod_df$vehicles = map_dbl(mod_df$report, extract_number, phrase = \"(?<=vehicles and fuel tanks [‒-–-] )\\\\d*\" )\n  # mod_df$special = map_dbl(mod_df$report, extract_number, phrase = \"(?<=special equipment [‒-–-] )\\\\d*\" )\n  mod_df$warships = map_dbl(mod_df$report, extract_number, phrase = \"(?<=warships / boats [‒-–-] )\\\\d*\" )\n  mod_df\n}\n\n#' Update the df that contains Ukraine MOD Russian casualty stats\n#'\n#' @param fname_ukr_mod_df file name of RData file that contains the stats\n#'\n#' @return Returns the updated df but also saves it to an RData file as a side effect.\n#' @export\n#'\n#' @examples\n#' update_ukr_mod_df(\"ukr_mod_df.RData\", save_fname_ukr_mod_df = \"test.RData\")\n#'\nupdate_ukr_mod_df <- function(fname_ukr_mod_df, from_date = NULL, to_date = NULL,\n                              days_previous = 20,\n                              save_fname_ukr_mod_df = NULL) {\n\n  if (1 == 2) {\n    ############################################################################\n    # Run the next line to update the data in ukr_mod_df.RData.\n    ############################################################################\n    update_ukr_mod_df(\"ukr_mod_df.RData\", save_fname_ukr_mod_df = \"ukr_mod_df.RData\")\n  }\n\n  load(fname_ukr_mod_df)\n\n  ############################################################################\n  # Here's the orginal sequence of dates that was used to initialize ukr_mod_df.\n  # the_dates <- seq(from = ymd(\"2022-04-15\"), to = today(), by = \"1 day\")\n  ############################################################################\n\n  # dates that need to be added to ukr_mod_df\n  if (is.null(from_date)) from_date <-  today() - days_previous\n  if (is.null(to_date)) to_date <- today()\n\n  additional_dates <- seq(from = from_date, to = to_date, by = \"1 day\")\n  abunch <- map_chr(additional_dates, fetch_ukr_mod_text, .progress = TRUE)\n  abunch <- abunch[!is.na(abunch)]\n\n  # ukr_mod_df <- tibble(report = abunch, date = ymd(str_sub(report, start = 1, end = 10)))\n  if (length(abunch > 0)) {\n    ukr_mod_page_additions <- tibble(report = abunch, date = ymd(str_sub(report, start = 1, end = 10)))\n    ukr_mod_additions <- parse_mod_text(ukr_mod_page_additions)\n  }\n\n  # use overlap_dates to check whether MOD has updated recent daata\n  # overlap_dates <- bind_rows(ukr_mod_df |> filter((ukr_mod_df$date %in% ukr_mod_additions$date)),\n  #                            ukr_mod_additions |> filter(ukr_mod_additions$date %in% ukr_mod_df$date)) |>\n  #   arrange(date) # |> View()\n\n  # save_ukr_mod__df <- ukr_mod_df\n  ukr_mod_df <- bind_rows(ukr_mod_df |> filter(!(ukr_mod_df$date %in% ukr_mod_additions$date)), ukr_mod_additions)\n\n  # calculate the number of days between each row\n  ukr_mod_df <- ukr_mod_df |> mutate(gap = as.numeric(date - lag(date, default = ukr_mod_df$date[1] - 1)))\n\n  # by default, save it back into the save file that it was loaded from\n  if (is.null(save_fname_ukr_mod_df)) save_fname_ukr_mod_df <- fname_ukr_mod_df\n  save(ukr_mod_df, file = save_fname_ukr_mod_df)\n  usethis::ui_done(glue::glue(\"Updated {save_fname_ukr_mod_df} through {max(ukr_mod_df$date, na.rm = TRUE)}.\"))\n  return(ukr_mod_df)\n}\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code .code-overflow-scroll  code-fold=\"true\" code-summary=\"Code which creates the summary plot\" code-line-numbers=\"true\"}\n# for_plot <- ukr_mod3 |> \n#   pivot_longer(cols = c(Personnel, Tanks, APV, Artillery, MLRS,\n#                         Helicopters, Aircraft), \n#                names_to = \"category\", values_to = \"count\") |> \n#   mutate(category = factor(category, levels = c(\"Personnel\", \"Tanks\", \"APV\",\n#                                                 \"Artillery\", \"MLRS\", \n#                                                 \"Helicopters\", \"Aircraft\")))\n# \n# p <- ggplot(data = for_plot, aes(x = date, y = count)) + \n#   geom_smooth(colour = \"darkgrey\") +\n#   geom_point() + \n#   facet_wrap(~ category, ncol = 1, scales = \"free_y\")\n\n#############################################################################\n#\n# Calculate average daily Russian losses by week. -> ukr_mod_weekly\n#\n#############################################################################\n\nukr_mod_weekly <- ukr_mod_df  |> arrange(date) |> \n  # isoweek of January 1 is 52, not 1\n  mutate(wk = if_else((isoweek(date) > 25) & (month(date) == 1),  year(date) - 1, year(date)) * 100 + isoweek(date)) |> \n  group_by(wk) |> \n  slice_tail(n = 1) |>  # as recommended by GPT\n  ungroup() |> \n  mutate(gap = as.numeric(date - lag(date, default = ukr_mod_df$date[1] - 1)),\n         Personnel = (personnel - lag(personnel)) / gap,\n         Tanks = (tanks - lag(tanks)) / gap,\n         APV = (apv - lag(apv)) / gap,\n         Artillery = (artillery - lag(artillery)) / gap,\n         MLRS = (mlrs - lag(mlrs)) / gap,\n         Helicopters = (helicopters - lag(helicopters)) / gap,\n         Aircraft = (aircraft - lag(aircraft)) / gap)\n\nfor_plot_wk <- ukr_mod_weekly |> \n  pivot_longer(cols = c(Personnel, Tanks, APV, Artillery, MLRS,\n                        Helicopters, Aircraft), \n               names_to = \"category\", values_to = \"count\")|> \n  mutate(category = factor(category, levels = c(\"Personnel\", \"Tanks\", \"APV\",\n                                                \"Artillery\", \"MLRS\", \n                                                \"Helicopters\", \"Aircraft\")))\nmilestones$category = factor(milestones$category, levels = levels(for_plot_wk$category))\n\nfull_milestones <- tidyr::crossing(levels(milestones$category), milestones$date)\npwk <- ggplot(data = for_plot_wk, aes(x = date, y = count)) + \n  # ylim(0, NA) +\n  geom_vline(data = tidyr::expand(milestones, category, date), mapping = aes(xintercept = date), colour = \"orange\") +\n  geom_smooth(colour = \"darkgrey\", span = 0.15) +\n  geom_point() + \n  geom_text(data = milestones, aes(label = key_symbol, y = Inf), colour = \"orange\", vjust = 1, hjust = 0) +\n  geom_text(data = milestones, aes(label = short_event, y = Inf), colour = \"darkgrey\", angle = 90, hjust = 1, vjust = 0) +\n  facet_wrap(~ category, ncol = 1, scales = \"free_y\") +\n  ggtitle(\"Ukranian MOD Reports of Average Daily Russian Losses\") + \n  xlab(\"\") + ylab(\"Average Daily Losses\") +\n  theme_minimal()\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![Weekly Russian Losses According to Ukraine Ministry of Defense](index_files/figure-html/display-weekley-plot-1.png){width=768}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}